<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="total">
        <div class="chat-container" id="chat-container">
            <!-- Chat messages will appear here -->
        </div>
        <div class="input-container">
            <input type="text" id="userMessage" class="input-box" placeholder="Message Graph Bot...">
            <button onclick="sendMessage()" class="send-button" id="sendButton" style="margin-right: 10px;">‚¨ÜÔ∏è</button>
            <button id="recordButton" style="margin-right: 10px;">üéôÔ∏è</button>
            <a href="/" class="modify-button">‚úíÔ∏è</a>
        </div>
    </div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
  </script>

<script type="module">  
const API_KEY = "{{ GOOGLE_API_KEY }}";
import { GoogleGenerativeAI } from "@google/generative-ai";
const genAI = new GoogleGenerativeAI(API_KEY);

async function run() {
    const model = genAI.getGenerativeModel({ model: "gemini-pro" });

    const chat = model.startChat({
        history: [],
    });

    async function doMessage(msg) {
        const result = await chat.sendMessageStream(msg);
        const newParagraph = $('<div class="message bot-message"></div>');
        const icon = $('<img class="icon" src="/static/images/bot_icon.png" alt="Bot Icon">');

        $('#chat-container').append(newParagraph);
        newParagraph.append(icon);

        let formattedText = "";

        async function displayTextWithDelay(text) {
            const words = text.split(/\s+/).filter(word => word.trim() !== '');
            const delayBetweenWords = 1000 / 10; // 5 words per second

            for (const word of words) {
                newParagraph.text(newParagraph.text() + word + ' ');
                await new Promise(resolve => setTimeout(resolve, delayBetweenWords));
            }
        }

        for await (const chunk of result.stream) {
            const chunkText = chunk.text();
            await displayTextWithDelay(chunkText);
            formattedText += chunkText;
        }

        formattedText = formatText(formattedText);
        newParagraph.html(formattedText);

        $('#chat-container').scrollTop($('#chat-container')[0].scrollHeight);
    }

    function formatText(text) {
        text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        text = text.replace(/\*(.*?)\*/g, "<em>$1</em>");
        text = text.replace(/\n/g, "<br>");
        return text;
    }

    function sendMessage() {
        var userInput = $('#userMessage').val();
        if (userInput.trim() !== '') {
            const icon = $('<img class="icon" src="/static/images/human_icon.png" alt="Human Icon">');
            const userMessage = $('<div class="message user-message" >' + userInput + '</div>');

            $('#chat-container').append(icon);
            $('#chat-container').append(userMessage);
            $('#userMessage').val('');
            doMessage(userInput);
        }
    }

    $('#sendButton').click(sendMessage);

    $('#userMessage').keypress(function(event) {
        if (event.which === 13) {
            sendMessage();
        }
    });
}

run();

    </script>
</body>
</html>
