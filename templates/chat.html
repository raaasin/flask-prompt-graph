<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
    </script>
</head>
<body>
    <div class="total">
        <div class="chat-container" id="chat-container">
            <!-- Chat messages will appear here -->
        </div>
        <div class="input-container">
            <input type="text" id="userMessage" class="input-box" placeholder="Message Graph Bot...">
            <button onclick="sendMessage()" class="send-button" id="sendButton" style="margin-right: 10px;">‚¨ÜÔ∏è</button>
            <button id="recordButton" style="margin-right: 10px;">üéôÔ∏è</button>
            <a href="/" class="modify-button">‚úíÔ∏è</a>
        </div>
    </div>



<script type="module">  

const API_KEY = "{{GEMINI_API_KEY}}";
import { GoogleGenerativeAI } from "@google/generative-ai";
const genAI = new GoogleGenerativeAI(API_KEY);
async function run() {
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-pro-latest" });

    const chat = model.startChat({
        history: [],
    });

    async function doMessage(msg) {
        var metadata = {
            "columns": "{{columns}}",
            "data_types": "{{data_types}}",
            "null_values": "{{null_values}}",
            "example_data": "{{example_data}}"
        };

        var prompt_eng = (
            "You are graphbot. If the user asks to plot a graph, you only reply with the Python code of Matplotlib to plot the graph and save it as graph.png." +
            "The data is in data.csv and its attributes are: Columns: " + metadata.columns + ", Data Types: " + metadata.data_types + ", Null Values: " + metadata.null_values + ". " +
            "If the user does not ask for a graph, you only reply with the answer to the query. " +
            "The user asks: " + msg
        );

        const result = await chat.sendMessageStream(prompt_eng);
        const newParagraph = $('<code class="message bot-message"></code>');
        const icon = $('<img class="icon" src="/static/images/bot_icon.png" alt="Bot Icon">');

        $('#chat-container').append(icon);
        $('#chat-container').append(newParagraph);
        

        let formattedText = "";

        async function displayTextWithDelay(text) {
            const words = text.split(/\s+/).filter(word => word.trim() !== '');
            //const correct = text.split(/\s+/).filter(word => word.trim() !== '' && word !== '```' && word !== 'python');
            //console.log(words);
            const delayBetweenWords = 1000 / 120; // 5 words per second

            for (const word of words) {
                newParagraph.text(newParagraph.text() + word + ' ');
                await new Promise(resolve => setTimeout(resolve, delayBetweenWords));
            }
        }

        for await (const chunk of result.stream) {
            var chunkText = chunk.text();
            console.log(chunkText);

            //remove ``` or python from chunkText
            chunkText = chunkText.replace(/```/g, '');
            chunkText = chunkText.replace(/python/g, '');

            await displayTextWithDelay(chunkText);
            formattedText += chunkText;
        }

        formattedText = formatText(formattedText);
        newParagraph.html(formattedText);

        $('#chat-container').scrollTop($('#chat-container')[0].scrollHeight);
    }

    function formatText(text) {
        text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        text = text.replace(/\*(.*?)\*/g, "<em>$1</em>");
        text = text.replace(/\n/g, "<br>");
        return text;
    }

    function sendMessage() {
        var userInput = $('#userMessage').val();
        if (userInput.trim() !== '') {
            const icon = $('<img class="icon" src="/static/images/human_icon.png" alt="Human Icon">');
            const userMessage = $('<div class="message user-message" >' + userInput + '</div>');

            $('#chat-container').append(icon);
            $('#chat-container').append(userMessage);
            $('#userMessage').val('');
            doMessage(userInput);
        }
    }

    $('#sendButton').click(sendMessage);

    $('#userMessage').keypress(function(event) {
        if (event.which === 13) {
            sendMessage();
        }
    });
}

run();

    </script>
</body>
</html>
